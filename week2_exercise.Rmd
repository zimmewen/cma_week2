---
title: "week2_exercise"
author: "Wenke Zimmermann"
date: "2022-05-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load the necessary libraries ###
```{r}
library(readr)        # to import tabular data (e.g. csv)
library(dplyr)        # to manipulate (tabular) data
library(ggplot2)      # to visualize data
library(udunits2)
library(sf)           # to handle spatial vector data
library(terra)        # To handle raster data
library(lubridate)    # To handle dates and times
```

## Task 1: Import your data
```{r}
# Import the downloaded csv #
wildschwein_BE <- read_delim("wildschwein_BE_2056.csv",",")

wildschwein_BE <- st_as_sf(wildschwein_BE, coords = c("E", "N"), crs = 2056, remove = FALSE)
```
#Note:
that this dataset is already converted to EPSG 2056
the coordinates are stored in the columns (E/N)
setting remove = FALSE preserves the original (E/N) columns, which come in handy later on


## Task 2: Getting an overview
Calculate the time difference between subsequent rows as described in the demo. You can calculate the time difference using the function difftime() in combination with lead().
- the function difftime() has an option units. Set this to secs to get the time difference in seconds
- use as.integer() to turn the output returned by difftime() into an integer.
- store the output in a new column (e.g. timelag)
```{r}
wildschwein_BE_tempdiff <- mutate(wildschwein_BE, timelag = as.integer(difftime(lead(DatetimeUTC),DatetimeUTC, units = "sec")))

wildschwein_BE_tempdiff
```

Now inspect your data in more detail. Try to answer the following questions:
- How many individuals were tracked?
- For how long were the individual tracked? Are there gaps?
- Were all individuals tracked concurrently or sequentially?
- What is the temporal sampling interval between the locations?
```{r}
##How many individuals
wildschwein_BE %>%
  group_by(TierID) %>%
  summarise(count=n())
#feature collection mit 3 features

#alternativ
#wildschwein_count <- wildschwein_BE %>%
#  group_by(TierID) %>%
#  summarise(count=n())
#nrow(wildschwein_count) #Ergebnis zeigt 3


##For how long were they tracked, are there gaps
ggplot(wildschwein_BE, aes(DatetimeUTC,TierName))+
  geom_line()
#almost a year (Aug 2014-Jul 2015), not every individual same duration, without gaps


##Were all individuals tracked concurrently or sequentially?
ggplot(wildschwein_BE_tempdiff, aes(timelag))+
  geom_bar()+
  scale_y_log10()+
  scale_x_continuous(limits = c(0,15000))
####Anzeige geht in die richtige Richtung aber unvollständig und warning message
#removed rows containing non-finite values (stat-count)
#indivduals were tracked sequentially


##What is the temporal sampling interval between the locations?
ggplot(wildschwein_BE_tempdiff, aes(DatetimeUTC,timelag, color=TierID))+
  geom_line()+
  geom_point()+
  scale_x_datetime(date_breaks="1 month", date_labels="%b")+
  scale_y_continuous(limits = c(0,20000))
#Grafik ähnelt der vorgegebenen, allerdings gab es warning messages, dass missing values removed
#und vermutlich sollte man zetiliche Auflösung runterschrauben

```


## Task 3: Deriving movement parameters I: Speed
```{r}
##Calculate steplength between two subsequent locations;
#Euclidian distance, E1,N1 refers to current location; E2,N2 refers to consecutive location
wildschwein_BE_tempdiff <- wildschwein_BE_tempdiff %>%
  mutate(steplength = sqrt((E-lead(E,1))^2+(N-lead(N,1))^2)
  )
#hat soweit funktioniert, aber Frage ob man nach Tier gruppieren sollte?!


##calculate speed, what's the unit?
wildschwein_BE_tempdiff <- wildschwein_BE_tempdiff %>%
  mutate(speed = steplength / timelag)
#guess it's m/s?!

```


## Task 4: Cross-scale movement analysis
```{r}
##Import caro-dataset
caro60 <- read_delim("caro60.csv",",")

caro60 <- st_as_sf(caro60, coords = c("E", "N"), crs = 2056, remove = FALSE)


##Reduce granularity
caro_3 <- caro60 %>%
  slice(seq(from = 1, to = 200, by = 3))  #'slice' nimmt Anzahl Zeilen heraus, 'seq' gibt ihm die Wiederholung aller drei Zeilen  

caro_6 <- caro60 %>%
  slice(seq(from = 1, to = 200, by = 6))

caro_9 <- caro60 %>%
  slice(seq(from = 1, to = 200, by = 9))

#control
nrow(caro60) #200
nrow(caro_3) #67
nrow(caro_6) #34
nrow(caro_9) #23


##calculate timelag, steplength, speed for each data set
#timelag
caro_3 <- mutate(caro_3, timelag = as.integer(difftime(lead(DatetimeUTC),DatetimeUTC, units = "sec")))

caro_6 <- mutate(caro_6, timelag = as.integer(difftime(lead(DatetimeUTC),DatetimeUTC, units = "sec")))

caro_9 <- mutate(caro_9, timelag = as.integer(difftime(lead(DatetimeUTC),DatetimeUTC, units = "sec")))

#steplength
caro_3 <- caro_3 %>%
  mutate(steplength = sqrt((E-lead(E,1))^2+(N-lead(N,1))^2)
  )

caro_6 <- caro_6 %>%
  mutate(steplength = sqrt((E-lead(E,1))^2+(N-lead(N,1))^2)
  )

caro_9 <- caro_9 %>%
  mutate(steplength = sqrt((E-lead(E,1))^2+(N-lead(N,1))^2)
  )

#speed
caro_3 <- caro_3 %>%
  mutate(speed = steplength / timelag)

caro_6 <- caro_6 %>%
  mutate(speed = steplength / timelag)

caro_9 <- caro_9 %>%
  mutate(speed = steplength / timelag)


##visualize trajectories in map




```


## Task 5: Deriving movement parameters II: Rolling window functions
```{r}

```


